#include <common/config.h>

.extern _on_interrupt

#ifdef _64BIT
	_call_interrupt:
		push rdi
		push rsi
		push rdx
		push rcx
		push rax
		push r8
		push r9
		push r10
		push r11

		mov rdi, rsp // pass the stack
		call _on_interrupt
		
		pop r11
		pop r10
		pop r9
		pop r8
		pop rax
		pop rcx
		pop rdx
		pop rsi
		pop rdi

		add rsp, 8+8 // pop vector + error
		iretq
#else
	_call_interrupt:
		pusha
		push ds
		push es
		push fs
		push gs
		push esp

		// push edi
		// push esi
		// push edx
		// push ecx
		// push eax
		// push ebp

		call _on_interrupt
		mov esp, eax # switch to new stack from interrupt
		
		// pop ebp
		// pop eax
		// pop ecx
		// pop edx
		// pop esi
		// pop edi

		pop gs
		pop fs
		pop es
		pop ds
		popa

		add esp, 4+4 # pop vector + error

		iret
#endif

.macro INTERRUPT vector
	_do_interrupt_\vector:
		push 0 // to match the error variants
		push \vector
		jmp _call_interrupt
.endm

.macro INTERRUPT_ERROR vector
	_do_interrupt_\vector:
		push \vector
		jmp _call_interrupt
.endm

.macro INTERRUPT_UNUSED vector
	_do_interrupt_\vector:
.endm

.macro INTERRUPT_IRQ vector
	INTERRUPT_UNUSED \vector
.endm

.macro INTERRUPT_IPI vector
	INTERRUPT_UNUSED \vector
.endm

INTERRUPT 0
INTERRUPT 1
INTERRUPT 2
INTERRUPT 3
INTERRUPT 4
INTERRUPT 5
INTERRUPT 6
INTERRUPT 7
INTERRUPT_ERROR 8
INTERRUPT 9
INTERRUPT_ERROR 10
INTERRUPT_ERROR 11
INTERRUPT_ERROR 12
INTERRUPT_ERROR 13
INTERRUPT_ERROR 14
INTERRUPT 15
INTERRUPT 16
INTERRUPT_ERROR 17
INTERRUPT 18
INTERRUPT 19
INTERRUPT 20
INTERRUPT 21
INTERRUPT 22
INTERRUPT 23
INTERRUPT 24
INTERRUPT 25
INTERRUPT 26
INTERRUPT 27
INTERRUPT 28
INTERRUPT 29
INTERRUPT_ERROR 30
INTERRUPT 31

INTERRUPT_UNUSED 32
INTERRUPT_UNUSED 33
INTERRUPT_UNUSED 34
INTERRUPT_UNUSED 35
INTERRUPT_UNUSED 36
INTERRUPT_UNUSED 37
INTERRUPT_UNUSED 38
INTERRUPT_UNUSED 39
INTERRUPT_UNUSED 40
INTERRUPT_UNUSED 41
INTERRUPT_UNUSED 42
INTERRUPT_UNUSED 43
INTERRUPT_UNUSED 44
INTERRUPT_UNUSED 45
INTERRUPT_UNUSED 46
INTERRUPT_UNUSED 47

// Other (IRQs)
INTERRUPT_IRQ 48
INTERRUPT_IRQ 49
INTERRUPT_IRQ 50
INTERRUPT_IRQ 51
INTERRUPT_IRQ 52
INTERRUPT_IRQ 53
INTERRUPT_IRQ 54
INTERRUPT_IRQ 55
INTERRUPT_IRQ 56
INTERRUPT_IRQ 57
INTERRUPT_IRQ 58
INTERRUPT_IRQ 59
INTERRUPT_IRQ 60
INTERRUPT_IRQ 61
INTERRUPT_IRQ 62
INTERRUPT_IRQ 63
INTERRUPT_IRQ 64
INTERRUPT_IRQ 65
INTERRUPT_IRQ 66
INTERRUPT_IRQ 67
INTERRUPT_IRQ 68
INTERRUPT_IRQ 69
INTERRUPT_IRQ 70
INTERRUPT_IRQ 71
INTERRUPT_IRQ 72
INTERRUPT_IRQ 73
INTERRUPT_IRQ 74
INTERRUPT_IRQ 75
INTERRUPT_IRQ 76
INTERRUPT_IRQ 77
INTERRUPT_IRQ 78
INTERRUPT_IRQ 79
INTERRUPT_IRQ 80
INTERRUPT_IRQ 81
INTERRUPT_IRQ 82
INTERRUPT_IRQ 83
INTERRUPT_IRQ 84
INTERRUPT_IRQ 85
INTERRUPT_IRQ 86
INTERRUPT_IRQ 87
INTERRUPT_IRQ 88
INTERRUPT_IRQ 89
INTERRUPT_IRQ 90
INTERRUPT_IRQ 91
INTERRUPT_IRQ 92
INTERRUPT_IRQ 93
INTERRUPT_IRQ 94
INTERRUPT_IRQ 95
INTERRUPT_IRQ 96
INTERRUPT_IRQ 97
INTERRUPT_IRQ 98
INTERRUPT_IRQ 99
INTERRUPT_IRQ 100
INTERRUPT_IRQ 101
INTERRUPT_IRQ 102
INTERRUPT_IRQ 103
INTERRUPT_IRQ 104
INTERRUPT_IRQ 105
INTERRUPT_IRQ 106
INTERRUPT_IRQ 107
INTERRUPT_IRQ 108
INTERRUPT_IRQ 109
INTERRUPT_IRQ 110
INTERRUPT_IRQ 111
INTERRUPT_IRQ 112
INTERRUPT_IRQ 113
INTERRUPT_IRQ 114
INTERRUPT_IRQ 115
INTERRUPT_IRQ 116
INTERRUPT_IRQ 117
INTERRUPT_IRQ 118
INTERRUPT_IRQ 119
INTERRUPT_IRQ 120
INTERRUPT_IRQ 121
INTERRUPT_IRQ 122
INTERRUPT_IRQ 123
INTERRUPT_IRQ 124
INTERRUPT_IRQ 125
INTERRUPT_IRQ 126
INTERRUPT_IRQ 127
INTERRUPT_IRQ 128
INTERRUPT_IRQ 129
INTERRUPT_IRQ 130
INTERRUPT_IRQ 131
INTERRUPT_IRQ 132
INTERRUPT_IRQ 133
INTERRUPT_IRQ 134
INTERRUPT_IRQ 135
INTERRUPT_IRQ 136
INTERRUPT_IRQ 137
INTERRUPT_IRQ 138
INTERRUPT_IRQ 139
INTERRUPT_IRQ 140
INTERRUPT_IRQ 141
INTERRUPT_IRQ 142
INTERRUPT_IRQ 143
INTERRUPT_IRQ 144
INTERRUPT_IRQ 145
INTERRUPT_IRQ 146
INTERRUPT_IRQ 147
INTERRUPT_IRQ 148
INTERRUPT_IRQ 149
INTERRUPT_IRQ 150
INTERRUPT_IRQ 151
INTERRUPT_IRQ 152
INTERRUPT_IRQ 153
INTERRUPT_IRQ 154
INTERRUPT_IRQ 155
INTERRUPT_IRQ 156
INTERRUPT_IRQ 157
INTERRUPT_IRQ 158
INTERRUPT_IRQ 159
INTERRUPT_IRQ 160
INTERRUPT_IRQ 161
INTERRUPT_IRQ 162
INTERRUPT_IRQ 163
INTERRUPT_IRQ 164
INTERRUPT_IRQ 165
INTERRUPT_IRQ 166
INTERRUPT_IRQ 167
INTERRUPT_IRQ 168
INTERRUPT_IRQ 169
INTERRUPT_IRQ 170
INTERRUPT_IRQ 171
INTERRUPT_IRQ 172
INTERRUPT_IRQ 173
INTERRUPT_IRQ 174
INTERRUPT_IRQ 175
INTERRUPT_IRQ 176
INTERRUPT_IRQ 177
INTERRUPT_IRQ 178
INTERRUPT_IRQ 179
INTERRUPT_IRQ 180
INTERRUPT_IRQ 181
INTERRUPT_IRQ 182
INTERRUPT_IRQ 183
INTERRUPT_IRQ 184
INTERRUPT_IRQ 185
INTERRUPT_IRQ 186
INTERRUPT_IRQ 187
INTERRUPT_IRQ 188
INTERRUPT_IRQ 189
INTERRUPT_IRQ 190
INTERRUPT_IRQ 191
INTERRUPT_IRQ 192
INTERRUPT_IRQ 193
INTERRUPT_IRQ 194
INTERRUPT_IRQ 195
INTERRUPT_IRQ 196
INTERRUPT_IRQ 197
INTERRUPT_IRQ 198
INTERRUPT_IRQ 199
INTERRUPT_IRQ 200
INTERRUPT_IRQ 201
INTERRUPT_IRQ 202
INTERRUPT_IRQ 203
INTERRUPT_IRQ 204
INTERRUPT_IRQ 205
INTERRUPT_IRQ 206
INTERRUPT_IRQ 207
INTERRUPT_IRQ 208
INTERRUPT_IRQ 209
INTERRUPT_IRQ 210
INTERRUPT_IRQ 211
INTERRUPT_IRQ 212
INTERRUPT_IRQ 213
INTERRUPT_IRQ 214
INTERRUPT_IRQ 215
INTERRUPT_IRQ 216
INTERRUPT_IRQ 217
INTERRUPT_IRQ 218
INTERRUPT_IRQ 219
INTERRUPT_IRQ 220
INTERRUPT_IRQ 221
INTERRUPT_IRQ 222
INTERRUPT_IRQ 223
INTERRUPT_IRQ 224
INTERRUPT_IRQ 225
INTERRUPT_IRQ 226
INTERRUPT_IRQ 227
INTERRUPT_IRQ 228
INTERRUPT_IRQ 229
INTERRUPT_IRQ 230
INTERRUPT_IRQ 231
INTERRUPT_IRQ 232
INTERRUPT_IRQ 233
INTERRUPT_IRQ 234
INTERRUPT_IRQ 235
INTERRUPT_IRQ 236
INTERRUPT_IRQ 237
INTERRUPT_IRQ 238
INTERRUPT_IRQ 239
INTERRUPT_IRQ 240
INTERRUPT_IRQ 241
INTERRUPT_IRQ 242
INTERRUPT_IRQ 243
INTERRUPT_IRQ 244
INTERRUPT_IRQ 245
INTERRUPT_IRQ 246
INTERRUPT_IRQ 247

// Careful changing these! They must match the values in interrupts.h
INTERRUPT_IPI 248 // sched_hint
INTERRUPT_IPI 249 // tlb_shootdown
INTERRUPT_IPI 250 // abort 
INTERRUPT 251 // NMI
INTERRUPT_IRQ 252 // LINT0
INTERRUPT_IRQ 253 // LINT1
INTERRUPT_IRQ 254 // LAPIC timer
INTERRUPT_UNUSED 255 // APIC Spurious interrupt vector

.global _vectors
_vectors:
	.long _do_interrupt_0
	.long _do_interrupt_1
	.long _do_interrupt_2
	.long _do_interrupt_3
	.long _do_interrupt_4
	.long _do_interrupt_5
	.long _do_interrupt_6
	.long _do_interrupt_7
	.long _do_interrupt_8
	.long _do_interrupt_9
	.long _do_interrupt_10
	.long _do_interrupt_11
	.long _do_interrupt_12
	.long _do_interrupt_13
	.long _do_interrupt_14
	.long _do_interrupt_15
	.long _do_interrupt_16
	.long _do_interrupt_17
	.long _do_interrupt_18
	.long _do_interrupt_19
	.long _do_interrupt_20
	.long _do_interrupt_21
	.long _do_interrupt_22
	.long _do_interrupt_23
	.long _do_interrupt_24
	.long _do_interrupt_25
	.long _do_interrupt_26
	.long _do_interrupt_27
	.long _do_interrupt_28
	.long _do_interrupt_29
	.long _do_interrupt_30
	.long _do_interrupt_31
