#include <common/config.h>

.extern _on_interrupt

#ifdef _64BIT
	_call_interrupt:
		push rdi
		push rsi
		push rdx
		push rcx
		push rax
		push r8
		push r9
		push r10
		push r11

		mov rdi, rsp // pass the stack
		call _on_interrupt
		
		pop r11
		pop r10
		pop r9
		pop r8
		pop rax
		pop rcx
		pop rdx
		pop rsi
		pop rdi

		add rsp, 8+8 // pop vector + error
		iretq
#else
	_call_interrupt:
		pusha
		push ds
		push es
		push fs
		push gs
		push esp

		// push edi
		// push esi
		// push edx
		// push ecx
		// push eax
		// push ebp

		call _on_interrupt
		mov esp, eax # switch to new stack from interrupt
		
		// pop ebp
		// pop eax
		// pop ecx
		// pop edx
		// pop esi
		// pop edi

		pop gs
		pop fs
		pop es
		pop ds
		popa

		add esp, 4+4 # pop vector + error

		iret
#endif

.macro INTERRUPT vector
	_do_interrupt_\vector:
		push 0 // to match the error variants
		push \vector
		jmp _call_interrupt
.endm

.macro INTERRUPT_ERROR vector
	_do_interrupt_\vector:
		push \vector
		jmp _call_interrupt
.endm

.macro INTERRUPT_UNUSED vector
	_do_interrupt_\vector:
.endm

.macro INTERRUPT_IRQ vector
	_do_interrupt_\vector:
		push 0 // to match the error variants
		push \vector
		jmp _call_interrupt
	// INTERRUPT_UNUSED \vector
.endm

.macro INTERRUPT_IPI vector
	INTERRUPT_UNUSED \vector
.endm

INTERRUPT 0
INTERRUPT 1
INTERRUPT 2
INTERRUPT 3
INTERRUPT 4
INTERRUPT 5
INTERRUPT 6
INTERRUPT 7
INTERRUPT_ERROR 8
INTERRUPT 9
INTERRUPT_ERROR 10
INTERRUPT_ERROR 11
INTERRUPT_ERROR 12
INTERRUPT_ERROR 13
INTERRUPT_ERROR 14
INTERRUPT 15
INTERRUPT 16
INTERRUPT_ERROR 17
INTERRUPT 18
INTERRUPT 19
INTERRUPT 20
INTERRUPT 21
INTERRUPT 22
INTERRUPT 23
INTERRUPT 24
INTERRUPT 25
INTERRUPT 26
INTERRUPT 27
INTERRUPT 28
INTERRUPT 29
INTERRUPT_ERROR 30
INTERRUPT 31

// IRQS (0-15)
INTERRUPT_IRQ 32
INTERRUPT_IRQ 33
INTERRUPT_IRQ 34
INTERRUPT_IRQ 35
INTERRUPT_IRQ 36
INTERRUPT_IRQ 37
INTERRUPT_IRQ 38
INTERRUPT_IRQ 39
INTERRUPT_IRQ 40
INTERRUPT_IRQ 41
INTERRUPT_IRQ 42
INTERRUPT_IRQ 43
INTERRUPT_IRQ 44
INTERRUPT_IRQ 45
INTERRUPT_IRQ 46
INTERRUPT_IRQ 47

INTERRUPT_UNUSED 48
INTERRUPT_UNUSED 49
INTERRUPT_UNUSED 50
INTERRUPT_UNUSED 51
INTERRUPT_UNUSED 52
INTERRUPT_UNUSED 53
INTERRUPT_UNUSED 54
INTERRUPT_UNUSED 55
INTERRUPT_UNUSED 56
INTERRUPT_UNUSED 57
INTERRUPT_UNUSED 58
INTERRUPT_UNUSED 59
INTERRUPT_UNUSED 60
INTERRUPT_UNUSED 61
INTERRUPT_UNUSED 62
INTERRUPT_UNUSED 63
INTERRUPT_UNUSED 64
INTERRUPT_UNUSED 65
INTERRUPT_UNUSED 66
INTERRUPT_UNUSED 67
INTERRUPT_UNUSED 68
INTERRUPT_UNUSED 69
INTERRUPT_UNUSED 70
INTERRUPT_UNUSED 71
INTERRUPT_UNUSED 72
INTERRUPT_UNUSED 73
INTERRUPT_UNUSED 74
INTERRUPT_UNUSED 75
INTERRUPT_UNUSED 76
INTERRUPT_UNUSED 77
INTERRUPT_UNUSED 78
INTERRUPT_UNUSED 79
INTERRUPT_UNUSED 80
INTERRUPT_UNUSED 81
INTERRUPT_UNUSED 82
INTERRUPT_UNUSED 83
INTERRUPT_UNUSED 84
INTERRUPT_UNUSED 85
INTERRUPT_UNUSED 86
INTERRUPT_UNUSED 87
INTERRUPT_UNUSED 88
INTERRUPT_UNUSED 89
INTERRUPT_UNUSED 90
INTERRUPT_UNUSED 91
INTERRUPT_UNUSED 92
INTERRUPT_UNUSED 93
INTERRUPT_UNUSED 94
INTERRUPT_UNUSED 95
INTERRUPT_UNUSED 96
INTERRUPT_UNUSED 97
INTERRUPT_UNUSED 98
INTERRUPT_UNUSED 99
INTERRUPT_UNUSED 100
INTERRUPT_UNUSED 101
INTERRUPT_UNUSED 102
INTERRUPT_UNUSED 103
INTERRUPT_UNUSED 104
INTERRUPT_UNUSED 105
INTERRUPT_UNUSED 106
INTERRUPT_UNUSED 107
INTERRUPT_UNUSED 108
INTERRUPT_UNUSED 109
INTERRUPT_UNUSED 110
INTERRUPT_UNUSED 111
INTERRUPT_UNUSED 112
INTERRUPT_UNUSED 113
INTERRUPT_UNUSED 114
INTERRUPT_UNUSED 115
INTERRUPT_UNUSED 116
INTERRUPT_UNUSED 117
INTERRUPT_UNUSED 118
INTERRUPT_UNUSED 119
INTERRUPT_UNUSED 120
INTERRUPT_UNUSED 121
INTERRUPT_UNUSED 122
INTERRUPT_UNUSED 123
INTERRUPT_UNUSED 124
INTERRUPT_UNUSED 125
INTERRUPT_UNUSED 126
INTERRUPT_UNUSED 127
INTERRUPT_UNUSED 128
INTERRUPT_UNUSED 129
INTERRUPT_UNUSED 130
INTERRUPT_UNUSED 131
INTERRUPT_UNUSED 132
INTERRUPT_UNUSED 133
INTERRUPT_UNUSED 134
INTERRUPT_UNUSED 135
INTERRUPT_UNUSED 136
INTERRUPT_UNUSED 137
INTERRUPT_UNUSED 138
INTERRUPT_UNUSED 139
INTERRUPT_UNUSED 140
INTERRUPT_UNUSED 141
INTERRUPT_UNUSED 142
INTERRUPT_UNUSED 143
INTERRUPT_UNUSED 144
INTERRUPT_UNUSED 145
INTERRUPT_UNUSED 146
INTERRUPT_UNUSED 147
INTERRUPT_UNUSED 148
INTERRUPT_UNUSED 149
INTERRUPT_UNUSED 150
INTERRUPT_UNUSED 151
INTERRUPT_UNUSED 152
INTERRUPT_UNUSED 153
INTERRUPT_UNUSED 154
INTERRUPT_UNUSED 155
INTERRUPT_UNUSED 156
INTERRUPT_UNUSED 157
INTERRUPT_UNUSED 158
INTERRUPT_UNUSED 159
INTERRUPT_UNUSED 160
INTERRUPT_UNUSED 161
INTERRUPT_UNUSED 162
INTERRUPT_UNUSED 163
INTERRUPT_UNUSED 164
INTERRUPT_UNUSED 165
INTERRUPT_UNUSED 166
INTERRUPT_UNUSED 167
INTERRUPT_UNUSED 168
INTERRUPT_UNUSED 169
INTERRUPT_UNUSED 170
INTERRUPT_UNUSED 171
INTERRUPT_UNUSED 172
INTERRUPT_UNUSED 173
INTERRUPT_UNUSED 174
INTERRUPT_UNUSED 175
INTERRUPT_UNUSED 176
INTERRUPT_UNUSED 177
INTERRUPT_UNUSED 178
INTERRUPT_UNUSED 179
INTERRUPT_UNUSED 180
INTERRUPT_UNUSED 181
INTERRUPT_UNUSED 182
INTERRUPT_UNUSED 183
INTERRUPT_UNUSED 184
INTERRUPT_UNUSED 185
INTERRUPT_UNUSED 186
INTERRUPT_UNUSED 187
INTERRUPT_UNUSED 188
INTERRUPT_UNUSED 189
INTERRUPT_UNUSED 190
INTERRUPT_UNUSED 191
INTERRUPT_UNUSED 192
INTERRUPT_UNUSED 193
INTERRUPT_UNUSED 194
INTERRUPT_UNUSED 195
INTERRUPT_UNUSED 196
INTERRUPT_UNUSED 197
INTERRUPT_UNUSED 198
INTERRUPT_UNUSED 199
INTERRUPT_UNUSED 200
INTERRUPT_UNUSED 201
INTERRUPT_UNUSED 202
INTERRUPT_UNUSED 203
INTERRUPT_UNUSED 204
INTERRUPT_UNUSED 205
INTERRUPT_UNUSED 206
INTERRUPT_UNUSED 207
INTERRUPT_UNUSED 208
INTERRUPT_UNUSED 209
INTERRUPT_UNUSED 210
INTERRUPT_UNUSED 211
INTERRUPT_UNUSED 212
INTERRUPT_UNUSED 213
INTERRUPT_UNUSED 214
INTERRUPT_UNUSED 215
INTERRUPT_UNUSED 216
INTERRUPT_UNUSED 217
INTERRUPT_UNUSED 218
INTERRUPT_UNUSED 219
INTERRUPT_UNUSED 220
INTERRUPT_UNUSED 221
INTERRUPT_UNUSED 222
INTERRUPT_UNUSED 223
INTERRUPT_UNUSED 224
INTERRUPT_UNUSED 225
INTERRUPT_UNUSED 226
INTERRUPT_UNUSED 227
INTERRUPT_UNUSED 228
INTERRUPT_UNUSED 229
INTERRUPT_UNUSED 230
INTERRUPT_UNUSED 231
INTERRUPT_UNUSED 232
INTERRUPT_UNUSED 233
INTERRUPT_UNUSED 234
INTERRUPT_UNUSED 235
INTERRUPT_UNUSED 236
INTERRUPT_UNUSED 237
INTERRUPT_UNUSED 238
INTERRUPT_UNUSED 239
INTERRUPT_UNUSED 240
INTERRUPT_UNUSED 241
INTERRUPT_UNUSED 242
INTERRUPT_UNUSED 243
INTERRUPT_UNUSED 244
INTERRUPT_UNUSED 245
INTERRUPT_UNUSED 246
INTERRUPT_UNUSED 247

// Careful changing these! They must match the values in interrupts.h
INTERRUPT_IPI 248 // sched_hint
INTERRUPT_IPI 249 // tlb_shootdown
INTERRUPT_IPI 250 // abort 
INTERRUPT 251 // NMI
INTERRUPT_IRQ 252 // LINT0
INTERRUPT_IRQ 253 // LINT1
INTERRUPT_IRQ 254 // LAPIC timer
INTERRUPT_UNUSED 255 // APIC Spurious interrupt vector

.global _vectors
_vectors:
	.long _do_interrupt_0
	.long _do_interrupt_1
	.long _do_interrupt_2
	.long _do_interrupt_3
	.long _do_interrupt_4
	.long _do_interrupt_5
	.long _do_interrupt_6
	.long _do_interrupt_7
	.long _do_interrupt_8
	.long _do_interrupt_9
	.long _do_interrupt_10
	.long _do_interrupt_11
	.long _do_interrupt_12
	.long _do_interrupt_13
	.long _do_interrupt_14
	.long _do_interrupt_15
	.long _do_interrupt_16
	.long _do_interrupt_17
	.long _do_interrupt_18
	.long _do_interrupt_19
	.long _do_interrupt_20
	.long _do_interrupt_21
	.long _do_interrupt_22
	.long _do_interrupt_23
	.long _do_interrupt_24
	.long _do_interrupt_25
	.long _do_interrupt_26
	.long _do_interrupt_27
	.long _do_interrupt_28
	.long _do_interrupt_29
	.long _do_interrupt_30
	.long _do_interrupt_31

	.long _do_interrupt_32
	.long _do_interrupt_33
	.long _do_interrupt_34
	.long _do_interrupt_35
	.long _do_interrupt_36
	.long _do_interrupt_37
	.long _do_interrupt_38
	.long _do_interrupt_39
	.long _do_interrupt_40
	.long _do_interrupt_41
	.long _do_interrupt_42
	.long _do_interrupt_43
	.long _do_interrupt_44
	.long _do_interrupt_45
	.long _do_interrupt_46
	.long _do_interrupt_47
